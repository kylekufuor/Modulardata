# =============================================================================
# docker-compose.yml - ModularData Local Development Stack
# =============================================================================
# Runs the complete stack locally:
# - API (FastAPI)
# - Worker (Celery)
# - Redis (Message Broker)
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose logs -f api    # View API logs
#   docker-compose down           # Stop all services
#
# Note: Supabase is used as external service (not containerized)
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Redis - Message Broker for Celery
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: modulardata-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # API - FastAPI Application
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: modulardata-api
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - REDIS_URL=redis://redis:6379/0
      # These should be set in .env file or passed via docker-compose
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Worker - Celery Background Tasks
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: modulardata-worker
    environment:
      - ENVIRONMENT=development
      - REDIS_URL=redis://redis:6379/0
      - CELERY_CONCURRENCY=4
      # These should be set in .env file or passed via docker-compose
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  redis_data:
    driver: local
